version: 2

models:
  - name: fact_charge_attempts
    description: "Incremental marts model that combines charge attempts and transactions data using outer join. Provides comprehensive view of charge attempts with associated transaction details where available."
    columns:
      - name: charge_point_id
        description: "Identifier for the charge point"
        tests:
          - not_null
      - name: connector_id
        description: "Identifier for the charging connector"
        tests:
          - not_null
      - name: charge_attempt_id
        description: "Surrogate key for the charge attempt, generated from charge_point_id, connector_id, and charge_attempt_start_ts."
        tests:
          - unique
          - not_null
      - name: charge_attempt_start_ts
        description: "Start timestamp of the charge attempt. Uses preparing_start_ts (coalesce of payload_ts and ingested_ts from StatusNotification) if available, otherwise transaction_start_ts."
        tests:
          - not_null
      - name: charge_attempt_stop_ts
        description: "Stop timestamp of the charge attempt. Uses transaction_stop_ts if transaction exists, otherwise preparing_stop_ts (coalesce of next_payload_ts and next_ingested_ts)."
      - name: preparing_unique_id
        description: "Unique identifier of the Status Notification OCPP message"
      - name: preparing_ingested_ts
        description: "Timestamp when the StatusNotification with status 'Preparing' was ingested"
      - name: preparing_payload_ts
        description: "Optional timestamp from the StatusNotification payload (when status is 'Preparing')"
      - name: preparing_next_payload_ts
        description: "Optional timestamp from the next StatusNotification payload after 'Preparing' status"
      - name: confirmation_ingested_ts
        description: "Timestamp when the status change confirmation was received"
      - name: previous_status
        description: "Status before changing to 'Preparing'"
      - name: status
        description: "Current status (should be 'Preparing')"
        tests:
          - accepted_values:
              arguments:
                values: ['Preparing']
      - name: next_status
        description: "Next status after 'Preparing' (e.g., 'Charging', 'Available', 'Faulted')"
      - name: id_tags
        description: "Array of RFID tags or user identifiers from charge attempt events"
      - name: id_tag_statuses
        description: "Array of authorization statuses from charge attempt events"
      - name: transaction_id
        description: "Transaction ID (from charge attempt or transaction data)"
        tests:
          - unique
      - name: transaction_ingested_ts
        description: "Earliest timestamp when any OCPP event for this transaction was ingested"
      - name: transaction_start_ts
        description: "Timestamp when the transaction started"
      - name: transaction_stop_ts
        description: "Timestamp when the transaction stopped"
      - name: transaction_stop_reason
        description: "Reason for stopping the transaction"
      - name: transaction_id_tags
        description: "Array of RFID tags or user identifiers from transaction events"
      - name: transaction_id_tag_statuses
        description: "Array of authorization statuses from transaction events"
      - name: meter_start_wh
        description: "Meter reading at transaction start (Wh)"
      - name: meter_stop_wh
        description: "Meter reading at transaction stop (Wh)"
      - name: energy_transferred_kwh
        description: "Total energy transferred in kWh"
      - name: error_codes
        description: "Array of error codes from both charge attempt events and StatusNotification events during the transaction"
      - name: is_successful
        description: "Boolean flag indicating if the charge attempt was successful. True when: there is a transaction, next status is not 'Faulted', transaction stop reason is 'Local', 'Remote' or 'EVDisconnected', and energy transferred is greater than 0.01 kWh."
      - name: incremental_ts
        description: "Latest incremental processing timestamp from both source models for incremental processing tracking"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - charge_point_id
              - connector_id
              - charge_attempt_start_ts

  - name: fact_interval_data
    description: "15-minute interval meter values. Provides average values for each measurand within each 15-minute interval. Use for rebates reporting and time-series analysis."
    columns:
      - name: charge_point_id
        description: "Unique identifier for the charging point"
        tests:
          - not_null
      - name: transaction_id
        description: "Unique identifier for the charging transaction"
        tests:
          - not_null
      - name: connector_id
        description: "Unique identifier for the connector within the charging point"
        tests:
          - not_null
      - name: ingested_ts
        description: "Timestamp when transaction was ingested into the system"
        tests:
          - not_null
      - name: measurand
        description: "Type of measurement (e.g., Energy.Active.Import.Register, Voltage, Current.Import)"
        tests:
          - not_null
      - name: unit
        description: "Unit of measurement (e.g., Wh, V, A, W)"
        tests:
          - not_null
      - name: phase
        description: "Electrical phase (e.g., L1, L2, L3) or null for single-phase measurements"
      - name: meter_15min_interval_start
        description: "Start timestamp of the 15-minute interval. For the first interval, this is the actual first measurement time; for subsequent intervals, it's the 15-minute boundary."
        tests:
          - not_null
      - name: meter_15min_interval_stop
        description: "End timestamp of the 15-minute interval. For the last interval, this is the actual last measurement time; for other intervals, it's the next 15-minute boundary."
        tests:
          - not_null
      - name: avg_value
        description: "Average value for the measurand within this 15-minute interval"
        tests:
          - not_null
      - name: _count
        description: "Number of measurements within this 15-minute interval"
        tests:
          - not_null
      - name: interval_data_id
        description: "Surrogate key for the interval data record, generated from charge_point_id, transaction_id, ingested_ts, connector_id, measurand, unit, phase, and meter_15min_interval_start"
        tests:
          - unique
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - charge_point_id
              - connector_id
              - transaction_id
              - ingested_ts
              - measurand
              - unit
              - phase
              - meter_15min_interval_start

  - name: fact_downtime_daily
    description: "Daily aggregation of charge point downtime derived from offline outages. Splits outages across calendar days and aggregates per charge point and port. Currently only OFFLINE type; FAULT can be added later."
    columns:
      - name: date_id
        description: "Calendar date for the downtime aggregation"
        tests:
          - not_null
      - name: charge_point_id
        description: "Identifier for the charge point"
        tests:
          - not_null
      - name: port_id
        description: "Port identifier associated with the charge point (may be null if unavailable)"
      - name: duration_minutes
        description: "Total downtime minutes for the date/charge_point/port combination"
        tests:
          - not_null
      - name: type
        description: "Downtime type. Currently always 'OFFLINE'."
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['OFFLINE', 'FAULTED']
      - name: downtime_id
        description: "Surrogate key for the downtime record, generated from date_id, charge_point_id, port_id, and type"
        tests:
          - unique
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - date_id
              - charge_point_id
              - port_id
              - type

  - name: fact_visits
    description: "Incremental marts model that groups charge attempts into visits. A visit is a sequence of charge attempts by the same driver (same idTag) on co-located chargers close in time. Uses two-step grouping: Step 1 groups attempts by charge_point_id within 2 minutes (inferring idTag if any attempt in the group has one). Step 2 groups these groups by location_id and idTag within 30 minutes (if idTag exists) or by charge_point_id within 2 minutes (if no idTag). Time gaps are measured from charge_attempt_stop_ts of one attempt to charge_attempt_start_ts of the next attempt."
    columns:
      - name: visit_id
        description: "Unique identifier for the visit, generated from location_id, first_charge_point_id, and visit_start_ts"
        tests:
          - not_null
          - unique
      - name: location_id
        description: "Location identifier where the visit occurred"
        tests:
          - not_null
      - name: id_tag
        description: "Driver identifier (RFID tag). Null for visits where authorization failed. May be inferred from subsequent authorized attempts within 2 minutes on the same charger."
      - name: visit_start_ts
        description: "Start timestamp of the first charge attempt in the visit (charge_attempt_start_ts)"
        tests:
          - not_null
      - name: visit_end_ts
        description: "Stop timestamp of the last charge attempt in the visit (charge_attempt_stop_ts)"
        tests:
          - not_null
      - name: charge_attempt_count
        description: "Number of charge attempts in this visit"
        tests:
          - not_null
      - name: charge_point_ids
        description: "Array of charge point IDs used during this visit"
      - name: connector_ids
        description: "Array of connector IDs used during this visit"
      - name: transaction_ids
        description: "Array of transaction IDs associated with this visit"
      - name: total_energy_transferred_kwh
        description: "Total energy transferred across all charge attempts in this visit (kWh)"
      - name: visit_duration_minutes
        description: "Duration of the visit in minutes (from first charge_attempt_start_ts to last charge_attempt_stop_ts)"
        tests:
          - not_null
      - name: first_charge_point_id
        description: "Charge point ID where the visit started"
      - name: last_charge_point_id
        description: "Charge point ID where the visit ended"
      - name: is_successful
        description: "Success status of the last charge attempt in the visit"
      - name: incremental_ts
        description: "Latest incremental processing timestamp for incremental processing tracking"
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - location_id
              - first_charge_point_id
              - visit_start_ts